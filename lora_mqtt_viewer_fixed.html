<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>LoRa MQTT Viewer - BPM & SpO‚ÇÇ</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2.5em;
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 800px;
      margin: 20px auto;
    }
    
    @media (max-width: 600px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      padding: 30px;
      border-radius: 15px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .bpm-card {
      border-left: 6px solid #e74c3c;
    }
    
    .spo2-card {
      border-left: 6px solid #3498db;
    }
    
    .label {
      font-size: 1.2em;
      color: #666;
      margin-bottom: 15px;
      font-weight: 500;
    }
    
    .value {
      font-size: 3.5em;
      font-weight: bold;
      margin: 15px 0;
    }
    
    .bpm-value { color: #e74c3c; }
    .spo2-value { color: #3498db; }
    
    .unit {
      font-size: 1.2em;
      color: #999;
    }
    
    .raw-data {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      font-size: 0.9em;
      color: #666;
      text-align: center;
    }
    
    /* === CLASSES PARA ESTADO DE ERRO/ALERTA === */
    .error-card {
      border-left: 5px solid #f39c12; /* Borda Laranja */
      background: #fff8e1; /* Fundo Amarelo Suave */
    }
    .error-value {
      color: #f39c12 !important; /* Cor do texto (Laranja) */
    }
    
    /* === CAIXA DE STATUS DO PACIENTE === */
    .status-box {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.3s ease;
      border-left: 8px solid;
    }
    
    /* Status: Paciente n√£o identificado (vermelho) */
    .status-box.not-identified {
      background: linear-gradient(135deg, #fee, #fdd);
      border-left-color: #e74c3c;
      color: #c0392b;
    }
    
    /* Status: Paciente identificado (verde) */
    .status-box.identified {
      background: linear-gradient(135deg, #efe, #dfd);
      border-left-color: #27ae60;
      color: #1e8449;
    }
    
    .status-icon {
      font-size: 2em;
      opacity: 0.8;
    }
    
    .status-content {
      flex: 1;
    }
    
    .status-title {
      font-size: 1.4em;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .status-description {
      font-size: 0.95em;
      opacity: 0.8;
    }
    
    .status-indicator {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-box.not-identified .status-indicator {
      background: #e74c3c;
    }
    
    .status-box.identified .status-indicator {
      background: #27ae60;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }
    
    /* === CAIXA DE TIMER === */
    .timer-box {
      max-width: 600px;
      margin: 20px auto;
      padding: 25px;
      border-radius: 16px;
      background: linear-gradient(135deg, #00d4aa, #00a3cc);
      color: white;
      box-shadow: 0 8px 20px rgba(0, 212, 170, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
    }
    
    .timer-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .timer-icon {
      font-size: 1.5em;
      opacity: 0.9;
    }
    
    .timer-label {
      font-size: 1.1em;
      font-weight: 500;
      opacity: 0.9;
    }
    
    .timer-right {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    .timer-display {
      font-size: 3.5em;
      font-weight: bold;
      line-height: 1;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .timer-status {
      font-size: 0.95em;
      opacity: 0.8;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.15);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9em;
    }
    
    .connection-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4ade80;
      animation: pulse 2s infinite;
    }
    
    .connection-dot.disconnected {
      background: #f87171;
    }
    
    /* === CAIXA DE DADOS DA SESS√ÉO === */
    .session-box {
      max-width: 600px;
      margin: 20px auto;
      padding: 25px;
      border-radius: 16px;
      background: linear-gradient(135deg, #4a5568, #2d3748);
      color: white;
      box-shadow: 0 8px 20px rgba(74, 85, 104, 0.4);
      transition: all 0.3s ease;
    }
    
    .session-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .session-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.3em;
      font-weight: 600;
    }
    
    .session-badge {
      background: rgba(139, 92, 246, 0.2);
      color: #a78bfa;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .session-subtitle {
      font-size: 0.9em;
      opacity: 0.7;
      margin-top: 4px;
    }
    
    .session-data {
      display: grid;
      gap: 12px;
    }
    
    .session-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.05);
      padding: 12px 16px;
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    
    .session-item:hover {
      background: rgba(255,255,255,0.08);
    }
    
    .session-item-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .session-icon {
      font-size: 1.2em;
    }
    
    .session-label {
      font-size: 0.95em;
      opacity: 0.9;
    }
    
    .session-value {
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }
    
    .session-value.empty {
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <h1>Monitor LoRaCare - Sinais Vitais</h1>
  
  <!-- === CAIXA DE STATUS DO PACIENTE === -->
  <div id="statusBox" class="status-box not-identified">
    <div class="status-icon" id="statusIcon">üë§</div>
    <div class="status-content">
      <div class="status-title" id="statusTitle">Paciente n√£o identificado</div>
      <div class="status-description" id="statusDescription">Posicione o dedo no sensor para iniciar a identifica√ß√£o</div>
    </div>
    <div class="status-indicator" id="statusIndicator"></div>
  </div>
  
  <!-- === CAIXA DE TIMER === -->
  <div id="timerBox" class="timer-box">
    <div class="timer-left">
      <div class="timer-icon">‚è±Ô∏è</div>
      <div class="timer-label">Tempo de Monitoramento</div>
    </div>
    <div class="timer-right">
      <div class="timer-display" id="timerDisplay">00:00</div>
      <div class="timer-status" id="timerStatus">Aguardando</div>
    </div>
    <div class="connection-status">
      <div class="connection-dot" id="connectionDot"></div>
      <span id="connectionText">Conectado</span>
    </div>
  </div>
  
  <div class="container">
    <div class="card bpm-card">
      <div class="label">‚ù§Ô∏è Batimentos Card√≠acos</div>
      <div class="value bpm-value" id="bpmValue">--</div>
      <span class="unit">BPM</span>
    </div>
    
    <div class="card spo2-card">
      <div class="label">ü´Å Satura√ß√£o de Oxig√™nio</div>
      <div class="value spo2-value" id="spo2Value">--</div>
      <span class="unit">%</span>
    </div>
  </div>
  
  <div class="raw-data" id="rawData">
    <strong>Dados RAW:</strong> Aguardando sensor...
  </div>
  
  <!-- === CAIXA DE DADOS DA SESS√ÉO === -->
  <div id="sessionBox" class="session-box">
    <div class="session-header">
      <div>
        <div class="session-title">
          <span>üìä</span>
          <span>Dados da Sess√£o</span>
        </div>
        <div class="session-subtitle">√öltima sess√£o</div>
      </div>
      <div class="session-badge" id="sessionBadge">üìã √öLTIMA SESS√ÉO</div>
    </div>
    
    <div class="session-data">
      <div class="session-item">
        <div class="session-item-left">
          <span class="session-icon">üïí</span>
          <span class="session-label">Finalizada em</span>
        </div>
        <span class="session-value" id="sessionEndTime">--</span>
      </div>
      
      <div class="session-item">
        <div class="session-item-left">
          <span class="session-icon">‚ù§Ô∏è</span>
          <span class="session-label">BPM final</span>
        </div>
        <span class="session-value" id="sessionFinalBpm">--</span>
      </div>
      
      <div class="session-item">
        <div class="session-item-left">
          <span class="session-icon">ü´Å</span>
          <span class="session-label">SpO‚ÇÇ final</span>
        </div>
        <span class="session-value" id="sessionFinalSpo2">--</span>
      </div>
      
      <div class="session-item">
        <div class="session-item-left">
          <span class="session-icon">üìà</span>
          <span class="session-label">BPM m√©dio</span>
        </div>
        <span class="session-value" id="sessionAvgBpm">--</span>
      </div>
      
      <div class="session-item">
        <div class="session-item-left">
          <span class="session-icon">üìä</span>
          <span class="session-label">SpO‚ÇÇ m√©dio</span>
        </div>
        <span class="session-value" id="sessionAvgSpo2">--</span>
      </div>
      
      <div class="session-item">
        <div class="session-item-left">
          <span class="session-icon">‚è±Ô∏è</span>
          <span class="session-label">Dura√ß√£o</span>
        </div>
        <span class="session-value" id="sessionDuration">--</span>
      </div>
    </div>
  </div>

  <script>
    // === CONFIGURA√á√ïES DE C√ÅLCULO ===
    const BPM_CONVERSION_FACTOR = 1000;  // Baseado na an√°lise dos dados
    const SPO2_CONVERSION_FACTOR = 1000; // Baseado na an√°lise dos dados
    
    // Hist√≥rico para c√°lculos (simples)
    let irHistory = [];
    let redHistory = [];
    
    // === ELEMENTOS DO DOM ===
    const statusBox = document.getElementById('statusBox');
    const statusIcon = document.getElementById('statusIcon');
    const statusTitle = document.getElementById('statusTitle');
    const statusDescription = document.getElementById('statusDescription');
    const statusIndicator = document.getElementById('statusIndicator');
    
    // Elementos do timer
    const timerDisplay = document.getElementById('timerDisplay');
    const timerStatus = document.getElementById('timerStatus');
    const connectionDot = document.getElementById('connectionDot');
    const connectionText = document.getElementById('connectionText');
    
    // === VARI√ÅVEIS DO TIMER ===
    let timerInterval = null;
    let timerStartTime = null;
    let isMonitoring = false;
    let elapsedSeconds = 0;
    
    // === VARI√ÅVEIS DA SESS√ÉO ===
    let currentSession = {
      bpmValues: [],
      spo2Values: [],
      startTime: null,
      endTime: null,
      isActive: false
    };
    
    // Elementos da sess√£o
    const sessionEndTime = document.getElementById('sessionEndTime');
    const sessionFinalBpm = document.getElementById('sessionFinalBpm');
    const sessionFinalSpo2 = document.getElementById('sessionFinalSpo2');
    const sessionAvgBpm = document.getElementById('sessionAvgBpm');
    const sessionAvgSpo2 = document.getElementById('sessionAvgSpo2');
    const sessionDuration = document.getElementById('sessionDuration');
    const sessionBadge = document.getElementById('sessionBadge');
    
    /**
     * Atualiza a caixa de status do paciente
     * @param {boolean} isIdentified - Se o paciente est√° identificado
     */
    function updatePatientStatus(isIdentified) {
      if (isIdentified) {
        // Paciente identificado (verde)
        statusBox.className = 'status-box identified';
        statusIcon.textContent = '‚úÖ';
        statusTitle.textContent = 'Paciente identificado';
        statusDescription.textContent = 'Monitoramento de sinais vitais em andamento';
        console.log('üü¢ Status: Paciente identificado');
      } else {
        // Paciente n√£o identificado (vermelho)
        statusBox.className = 'status-box not-identified';
        statusIcon.textContent = 'üë§';
        statusTitle.textContent = 'Paciente n√£o identificado';
        statusDescription.textContent = 'Posicione o dedo no sensor para iniciar a identifica√ß√£o';
        console.log('üî¥ Status: Paciente n√£o identificado');
      }
    }
    
    /**
     * Formatar tempo em MM:SS
     * @param {number} seconds - Segundos totais
     * @returns {string} - Tempo formatado
     */
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    /**
     * Inicia o timer de monitoramento
     */
    function startTimer() {
      if (isMonitoring) return; // J√° est√° rodando
      
      console.log('‚è±Ô∏è Iniciando timer de monitoramento');
      isMonitoring = true;
      timerStartTime = Date.now();
      elapsedSeconds = 0;
      
      // Iniciar nova sess√£o
      startSession();
      
      // Atualizar status do timer
      timerStatus.textContent = 'Monitorando';
      
      // Iniciar intervalo de atualiza√ß√£o
      timerInterval = setInterval(() => {
        elapsedSeconds = Math.floor((Date.now() - timerStartTime) / 1000);
        timerDisplay.textContent = formatTime(elapsedSeconds);
      }, 1000);
    }
    
    /**
     * Para o timer de monitoramento
     */
    function stopTimer() {
      if (!isMonitoring) return; // J√° est√° parado
      
      console.log('‚èπÔ∏è Parando timer de monitoramento');
      isMonitoring = false;
      
      // Finalizar sess√£o atual
      endSession();
      
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      // Atualizar status do timer
      timerStatus.textContent = 'Aguardando';
      
      // Resetar display para 00:00
      timerDisplay.textContent = '00:00';
      elapsedSeconds = 0;
    }
    
    /**
     * Atualiza o status de conex√£o
     * @param {boolean} isConnected - Se est√° conectado
     */
    function updateConnectionStatus(isConnected) {
      if (isConnected) {
        connectionDot.className = 'connection-dot';
        connectionText.textContent = 'Conectado';
      } else {
        connectionDot.className = 'connection-dot disconnected';
        connectionText.textContent = 'Desconectado';
      }
    }
    
    /**
     * Carrega a √∫ltima sess√£o do localStorage
     */
    function loadLastSession() {
      try {
        const savedSession = localStorage.getItem('loracare_last_session');
        if (savedSession) {
          const session = JSON.parse(savedSession);
          updateSessionDisplay(session);
          console.log('üìã √öltima sess√£o carregada:', session);
        } else {
          console.log('üìã Nenhuma sess√£o anterior encontrada');
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar sess√£o:', error);
      }
    }
    
    /**
     * Salva a sess√£o no localStorage
     * @param {Object} session - Dados da sess√£o
     */
    function saveSession(session) {
      try {
        localStorage.setItem('loracare_last_session', JSON.stringify(session));
        console.log('üíæ Sess√£o salva no localStorage:', session);
      } catch (error) {
        console.error('‚ùå Erro ao salvar sess√£o:', error);
      }
    }
    
    /**
     * Inicia uma nova sess√£o
     */
    function startSession() {
      console.log('üöÄ Iniciando nova sess√£o');
      currentSession = {
        bpmValues: [],
        spo2Values: [],
        startTime: new Date(),
        endTime: null,
        isActive: true
      };
      
      // Atualizar badge para sess√£o atual
      sessionBadge.textContent = 'üî¥ SESS√ÉO ATIVA';
      sessionBadge.style.background = 'rgba(34, 197, 94, 0.2)';
      sessionBadge.style.color = '#4ade80';
    }
    
    /**
     * Finaliza a sess√£o atual e salva
     */
    function endSession() {
      if (!currentSession.isActive) return;
      
      console.log('üèÅ Finalizando sess√£o');
      currentSession.endTime = new Date();
      currentSession.isActive = false;
      
      // Calcular dados da sess√£o
      const sessionData = {
        endTime: currentSession.endTime.toLocaleTimeString('pt-BR'),
        endDate: currentSession.endTime.toLocaleDateString('pt-BR'),
        finalBpm: currentSession.bpmValues.length > 0 
          ? currentSession.bpmValues[currentSession.bpmValues.length - 1] 
          : null,
        finalSpo2: currentSession.spo2Values.length > 0
          ? currentSession.spo2Values[currentSession.spo2Values.length - 1]
          : null,
        avgBpm: currentSession.bpmValues.length > 0
          ? Math.round(currentSession.bpmValues.reduce((a, b) => a + b, 0) / currentSession.bpmValues.length)
          : null,
        avgSpo2: currentSession.spo2Values.length > 0
          ? Math.round(currentSession.spo2Values.reduce((a, b) => a + b, 0) / currentSession.spo2Values.length)
          : null,
        duration: elapsedSeconds,
        totalReadings: currentSession.bpmValues.length
      };
      
      // Salvar no localStorage
      saveSession(sessionData);
      
      // Atualizar display
      updateSessionDisplay(sessionData);
      
      // Resetar badge
      sessionBadge.textContent = 'üìã √öLTIMA SESS√ÉO';
      sessionBadge.style.background = 'rgba(139, 92, 246, 0.2)';
      sessionBadge.style.color = '#a78bfa';
    }
    
    /**
     * Adiciona valores √† sess√£o atual
     * @param {number} bpm - Valor BPM
     * @param {number} spo2 - Valor SpO2
     */
    function addToSession(bpm, spo2) {
      if (!currentSession.isActive) return;
      
      if (bpm && bmp > 0) {
        currentSession.bpmValues.push(bpm);
      }
      
      if (spo2 && spo2 > 0) {
        currentSession.spo2Values.push(spo2);
      }
      
      console.log(`üìä Adicionado √† sess√£o: BPM=${bpm}, SpO2=${spo2}% (Total: ${currentSession.bpmValues.length} leituras)`);
    }
    
    /**
     * Atualiza o display da sess√£o
     * @param {Object} sessionData - Dados da sess√£o
     */
    function updateSessionDisplay(sessionData) {
      sessionEndTime.textContent = sessionData.endTime || '--';
      sessionFinalBpm.textContent = sessionData.finalBpm ? `${sessionData.finalBpm} BPM` : '--';
      sessionFinalSpo2.textContent = sessionData.finalSpo2 ? `${sessionData.finalSpo2}%` : '--';
      sessionAvgBpm.textContent = sessionData.avgBpm ? `${sessionData.avgBpm} BPM` : '--';
      sessionAvgSpo2.textContent = sessionData.avgSpo2 ? `${sessionData.avgSpo2}%` : '--';
      sessionDuration.textContent = sessionData.duration ? formatTime(sessionData.duration) : '--';
      
      // Aplicar classe empty se n√£o houver dados
      [sessionEndTime, sessionFinalBpm, sessionFinalSpo2, sessionAvgBpm, sessionAvgSpo2, sessionDuration].forEach(el => {
        if (el.textContent === '--') {
          el.classList.add('empty');
        } else {
          el.classList.remove('empty');
        }
      });
    }
    
    /**
     * Calcula BPM baseado nos valores IR
     * Analogia: Monitoramento das oscila√ß√µes r√≠tmicas (componente AC)
     */
    function calculateBPM(irValue, redValue) {
      if (!irValue || !redValue) return null;
      
      // Convers√£o simples baseada na m√©dia dos valores
      // Em um sistema real, seria an√°lise de frequ√™ncia dos picos
      const avgValue = (irValue + redValue) / 2;
      const bmp = Math.round(avgValue / BPM_CONVERSION_FACTOR);
      
      // Limitar a faixa realista (40-200 BPM)
      return Math.max(40, Math.min(200, bpm));
    }
    
    /**
     * Calcula SpO‚ÇÇ baseado na raz√£o IR/RED
     * Analogia: Lei de Beer-Lambert - Raz√£o de absor√ß√£o dos comprimentos de onda
     */
    function calculateSpO2(irValue, redValue) {
      if (!irValue || !redValue) return null;
      
      // C√°lculo simplificado da raz√£o R
      // Em sistema real: R = (AC_RED/DC_RED) / (AC_IR/DC_IR)
      const ratio = redValue / irValue;
      
      // F√≥rmula de calibra√ß√£o aproximada: SpO‚ÇÇ = 110 - 25 √ó R
      // Ajustada para nossos valores de sensor
      let spo2 = 110 - (25 * ratio);
      
      // Normalizar para faixa realista (70-100%)
      spo2 = Math.max(70, Math.min(100, Math.round(spo2)));
      
      return spo2;
    }
    
    async function fetchData() {
      try {
        const res = await fetch("http://localhost:3000/api/data");
        const data = await res.json();
        
        if (data && Object.keys(data).length > 0) {
          
          // === L√ìGICA DE REA√á√ÉO AO STATUS ===
          
          // Atualizar status de conex√£o
          updateConnectionStatus(true);
          
          // A. CONDI√á√ÉO DE ERRO (data.status === "ERRO" ou ir==0 e red==0)
          if (data.status === "ERRO" || (data.ir === 0 && data.red === 0)) {
            console.log('‚ö†Ô∏è STATUS ERRO - Dedo fora do sensor');
            
            // Parar timer se estava rodando
            if (isMonitoring) {
              stopTimer();
            }
            
            // Atualizar status do paciente
            updatePatientStatus(false);
            
            // Limpar os valores
            document.getElementById("bmpValue").textContent = '‚Äî';
            document.getElementById("spo2Value").textContent = '‚Äî';
            
            // Mudar o estilo - Aplicar tema Laranja/Amarelo
            const bmpCard = document.querySelector('.bmp-card, .error-card');
            const spo2Card = document.querySelector('.spo2-card, .error-card');
            const bmpValue = document.getElementById("bmpValue");
            const spo2Value = document.getElementById("spo2Value");
            
            // Remover classes normais e adicionar classes de erro
            bmpCard.classList.remove('bmp-card');
            bmpCard.classList.add('error-card');
            spo2Card.classList.remove('spo2-card');
            spo2Card.classList.add('error-card');
            
            bmpValue.classList.remove('bmp-value');
            bmpValue.classList.add('error-value');
            spo2Value.classList.remove('spo2-value');
            spo2Value.classList.add('error-value');
            
            // Alerta ao usu√°rio
            document.getElementById("rawData").innerHTML = `
              <strong>‚ö†Ô∏è DEDO FORA DO SENSOR / LEITURA INV√ÅLIDA</strong>
            `;
            
          // B. CONDI√á√ÉO DE OK (data.status === "OK" e valores v√°lidos)
          } else if (data.status === "OK" && data.ir > 0 && data.red > 0) {
            console.log('‚úÖ STATUS OK - Leitura v√°lida');
            
            // Iniciar timer se n√£o estava rodando
            if (!isMonitoring) {
              startTimer();
            }
            
            // Atualizar status do paciente
            updatePatientStatus(true);
            
            // Calcular e Exibir valores normalmente
            const bpm = calculateBPM(data.ir, data.red);
            const spo2 = calculateSpO2(data.ir, data.red);
            
            // Atualizar displays
            document.getElementById("bmpValue").textContent = bpm || '--';
            document.getElementById("spo2Value").textContent = spo2 || '--';
            
            // Adicionar valores √† sess√£o atual
            if (bpm && spo2) {
              addToSession(bpm, spo2);
            }
            
            // Restaurar o estilo - Aplicar tema Vermelho/Azul original
            const bmpCard = document.querySelector('.bmp-card, .error-card');
            const spo2Card = document.querySelector('.spo2-card, .error-card');
            const bmpValue = document.getElementById("bmpValue");
            const spo2Value = document.getElementById("spo2Value");
            
            // Remover classes de erro e restaurar classes originais
            bmpCard.classList.remove('error-card');
            bmpCard.classList.add('bmp-card');
            spo2Card.classList.remove('error-card');
            spo2Card.classList.add('spo2-card');
            
            bmpValue.classList.remove('error-value');
            bmpValue.classList.add('bmp-value');
            spo2Value.classList.remove('error-value');
            spo2Value.classList.add('spo2-value');
            
            // Exibir dados RAW normalmente
            document.getElementById("rawData").innerHTML = `
              <strong>Dados RAW:</strong> 
              IR: ${data.ir} | RED: ${data.red} | 
              Raz√£o: ${(data.red / data.ir).toFixed(3)} | 
              Status: ${data.status}
            `;
            
            console.log(`üìä BPM: ${bpm}, SpO‚ÇÇ: ${spo2}% (IR: ${data.ir}, RED: ${data.red}, Status: ${data.status})`);
            
          } else {
            // Fallback para dados sem status definido
            console.log('‚ö†Ô∏è Status indefinido, usando l√≥gica antiga');
            
            const bpm = calculateBPM(data.ir, data.red);
            const spo2 = calculateSpO2(data.ir, data.red);
            
            document.getElementById("bmpValue").textContent = bpm || '--';
            document.getElementById("spo2Value").textContent = spo2 || '--';
            
            document.getElementById("rawData").innerHTML = `
              <strong>Dados RAW:</strong> 
              IR: ${data.ir} | RED: ${data.red} | 
              Raz√£o: ${(data.red / data.ir).toFixed(3)}
            `;
          }
          
        } else {
          // Sem dados - paciente n√£o identificado
          updateConnectionStatus(false);
          
          // Parar timer se estava rodando
          if (isMonitoring) {
            stopTimer();
          }
          
          updatePatientStatus(false);
          document.getElementById("bmpValue").textContent = '--';
          document.getElementById("spo2Value").textContent = '--';
          document.getElementById("rawData").textContent = 'Nenhum dado recebido ainda...';
        }
      } catch (err) {
        console.error("Erro ao buscar API:", err);
        
        // Erro de conex√£o - atualizar status
        updateConnectionStatus(false);
        
        // Parar timer se estava rodando
        if (isMonitoring) {
          stopTimer();
        }
        
        // Erro de conex√£o - paciente n√£o identificado
        updatePatientStatus(false);
        document.getElementById("bmpValue").textContent = '--';
        document.getElementById("spo2Value").textContent = '--';
        document.getElementById("rawData").textContent = 'Erro ao conectar com sensor!';
      }
    }

    // Inicializa√ß√£o da p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ LoRaCare iniciado');
      
      // Carregar √∫ltima sess√£o do localStorage
      loadLastSession();
      
      console.log('‚úÖ Sistema inicializado');
    });

    // Atualiza a cada 2 segundos
    setInterval(fetchData, 2000);
    fetchData();
  </script>
</body>
</html>