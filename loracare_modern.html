<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LoRaCare ‚Äî Monitoramento de Sa√∫de</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    :root{
      --bg-1: #5A8DEE;
      --bg-2: #845EC2;
      --card-bg: #FFFFFF;
      --muted: #F8F9FC;
      --status-green: #28C76F;
      --status-red: #EA5455;
      --timer-blue: #00CFE8;
      --bpm-red: #FF6B6B;
      --spo2-blue: #4BC0C0;
      --sensor-bg: #2F3640;
      --sensor-text: #F5F6FA;
      
      /* Slide colors */
      --slide-green-dark: #2D6A4F;
      --slide-green-light: #95D5B2;
    }

    /* Theme 1: Original Technological (Autoral) */
    body.theme-original {
      background: linear-gradient(135deg, #5A8DEE, #845EC2);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      min-height: 100vh;
    }

    /* Theme 2: Bridge with Slides */
    body.theme-bridge {
      background: linear-gradient(135deg, #74C69D, #5A8DEE, #9A8FCB);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      min-height: 100vh;
    }

    /* Card rounded and shadow style */
    .card{
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      padding: 1.25rem;
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }

    /* Status card left accent */
    .status-accent{
      border-left-width: 8px;
      border-left-style: solid;
    }

    /* Sensor card dark style */
    .sensor-card{
      background: linear-gradient(180deg, rgba(47,54,64,1), rgba(38,45,52,1));
      color: var(--sensor-text);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.18);
    }

    /* Timer with gradient */
    .timer-circle{
      background: linear-gradient(180deg,#00CFE8,#1CA9B8);
      border-radius: 12px;
      padding: 1.25rem;
      color: white;
    }

    /* Theme-specific timer for bridge theme */
    body.theme-bridge .timer-circle {
      background: linear-gradient(180deg, #2D6A4F, #1A5A3A);
    }

    /* Connection pill */
    .pill{ 
      display:inline-flex; 
      align-items:center; 
      gap:8px; 
      padding:6px 12px; 
      border-radius:999px; 
    }

    /* Pulse animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .pulse { animation: pulse 2s infinite; }

    /* Status colors - original theme */
    body.theme-original .status-green {
      border-left-color: var(--status-green) !important;
      color: var(--status-green) !important;
    }
    
    body.theme-original .status-red {
      border-left-color: var(--status-red) !important;
      color: var(--status-red) !important;
    }

    /* Status colors - bridge theme (using slide colors) */
    body.theme-bridge .status-green {
      border-left-color: var(--slide-green-dark) !important;
      color: var(--slide-green-dark) !important;
    }
    
    body.theme-bridge .status-red {
      border-left-color: var(--status-red) !important;
      color: var(--status-red) !important;
    }

    /* Metric values with colors */
    body.theme-original .bpm-value { color: var(--bpm-red); }
    body.theme-original .spo2-value { color: var(--spo2-blue); }

    body.theme-bridge .bpm-value { color: #D2691E; } /* Terra cotta for BPM */
    body.theme-bridge .spo2-value { color: var(--slide-green-dark); } /* Slide green for SpO2 */

    /* Theme toggle button */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-radius: 50px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid rgba(255,255,255,0.2);
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,1);
      transform: scale(1.05);
    }

    /* Theme indicators */
    .theme-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .theme-indicator.original {
      background: linear-gradient(45deg, #5A8DEE, #845EC2);
    }

    .theme-indicator.bridge {
      background: linear-gradient(45deg, #74C69D, #2D6A4F);
    }

  </style>
</head>
<body class="text-gray-800 theme-original">
  <!-- Theme Toggle Button -->
  <div class="theme-toggle" id="themeToggle">
    <span class="theme-indicator original" id="themeIndicator"></span>
    <span id="themeText">Tema Autoral</span>
  </div>
  <div class="max-w-7xl mx-auto p-8">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-4xl font-light text-white">LoRaCare</h1>
      <p class="text-white/80 mt-2">Monitoramento de Sa√∫de em Tempo Real</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left column (spans 2 on large screens) -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Status card -->
        <div id="statusCard" class="card status-accent status-red flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-100">
              <i id="statusIcon" data-lucide="user-x" class="w-6 h-6 text-red-500"></i>
            </div>
            <div>
              <h2 id="statusTitle" class="text-2xl font-semibold">Paciente n√£o identificado</h2>
              <p class="text-sm text-gray-500 mt-1">Posicione o dedo no sensor para iniciar a identifica√ß√£o</p>
            </div>
          </div>
          <div class="flex flex-col items-center gap-2">
            <div id="statusDot" class="w-4 h-4 rounded-full bg-red-500 pulse"></div>
            <div class="text-xs text-gray-400">Status</div>
          </div>
        </div>

        <!-- Metrics row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- BPM -->
          <div class="card flex flex-col items-center justify-center min-h-[12rem] relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-red-400 to-red-600"></div>
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="heart" class="w-5 h-5 text-red-500"></i>
              <h3 class="text-gray-400 uppercase tracking-wide text-sm">Batimentos Card√≠acos</h3>
            </div>
            <div id="bpmValue" class="text-5xl font-semibold mt-4 bpm-value">--</div>
            <div class="text-xs text-gray-400 mt-2">BPM</div>
            <div id="bpmStatus" class="mt-3 px-3 py-1 rounded-full text-xs font-medium" style="display: none;">Normal</div>
          </div>

          <!-- SpO2 -->
          <div class="card flex flex-col items-center justify-center min-h-[12rem] relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-400 to-blue-600"></div>
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="activity" class="w-5 h-5 text-blue-500"></i>
              <h3 class="text-gray-400 uppercase tracking-wide text-sm">Oxigena√ß√£o</h3>
            </div>
            <div id="spo2Value" class="text-5xl font-semibold mt-4 spo2-value">--</div>
            <div class="text-xs text-gray-400 mt-2">%</div>
            <div id="spo2Status" class="mt-3 px-3 py-1 rounded-full text-xs font-medium" style="display: none;">Normal</div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <aside class="space-y-6">
        <!-- Timer card -->
        <div class="timer-circle card">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <i data-lucide="timer" class="w-6 h-6 opacity-90"></i>
              <div class="text-sm">Tempo de Monitoramento</div>
            </div>
            <div id="connPill" class="pill bg-white/20 text-white text-sm">
              <span id="connDot" class="w-3 h-3 rounded-full bg-red-400 inline-block"></span>
              <span id="connText">Desconectado</span>
            </div>
          </div>

          <div class="mt-6 text-center">
            <div id="timerDisplay" class="text-5xl font-bold">00:00</div>
            <div id="timerSub" class="text-xs mt-2 text-white/80">Aguardando</div>
          </div>
        </div>

        <!-- Session Data Card -->
        <div class="sensor-card">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <i data-lucide="activity" class="w-6 h-6"></i>
              <h4 class="font-semibold">Dados da Sess√£o</h4>
            </div>
            <div class="text-xs text-gray-300" id="sessionStatus">Em tempo real</div>
          </div>

          <!-- Current Session (visible during monitoring) -->
          <div id="currentSessionData" style="display: none;">
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">üìä SESS√ÉO ATUAL</div>
              <div class="space-y-2">
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">‚ù§Ô∏è BPM atual</div>
                  <div id="currentBpm" class="text-sm text-gray-200 font-mono">--</div>
                </div>
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">ü´Å SpO‚ÇÇ atual</div>
                  <div id="currentSpo2" class="text-sm text-gray-200 font-mono">--</div>
                </div>
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">üìà BPM m√©dio</div>
                  <div id="avgBpm" class="text-sm text-cyan-300 font-mono">--</div>
                </div>
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">üìà SpO‚ÇÇ m√©dio</div>
                  <div id="avgSpo2" class="text-sm text-cyan-300 font-mono">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Last Session Data (visible when no finger detected) -->
          <div id="lastSessionData">
            <div class="mb-4">
              <div class="text-xs text-gray-400 mb-2">üíæ √öLTIMA SESS√ÉO</div>
              <div class="space-y-2">
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">üïí Finalizada em</div>
                  <div id="lastSessionTime" class="text-sm text-gray-200 font-mono">--</div>
                </div>
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">‚ù§Ô∏è BPM final</div>
                  <div id="lastBpm" class="text-sm text-gray-200 font-mono">--</div>
                </div>
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">ü´Å SpO‚ÇÇ final</div>
                  <div id="lastSpo2" class="text-sm text-gray-200 font-mono">--</div>
                </div>
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">üìä BPM m√©dio</div>
                  <div id="lastAvgBpm" class="text-sm text-cyan-300 font-mono">--</div>
                </div>
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">üìä SpO‚ÇÇ m√©dio</div>
                  <div id="lastAvgSpo2" class="text-sm text-cyan-300 font-mono">--</div>
                </div>
                <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                  <div class="text-sm text-gray-200">‚è±Ô∏è Dura√ß√£o</div>
                  <div id="lastSessionDuration" class="text-sm text-gray-200 font-mono">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Raw Sensor Data -->
          <div class="border-t border-white/10 pt-4">
            <div class="text-xs text-gray-400 mb-2">üî¨ DADOS BRUTOS</div>
            <div class="space-y-2">
              <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                <div class="text-sm text-gray-200">IR</div>
                <div id="irVal" class="text-sm text-gray-200 font-mono">--</div>
              </div>
              <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                <div class="text-sm text-gray-200">RED</div>
                <div id="redVal" class="text-sm text-gray-200 font-mono">--</div>
              </div>
              <div class="flex items-center justify-between bg-white/6 rounded-md p-3">
                <div class="text-sm text-gray-200">Atualizado</div>
                <div id="lastUpdate" class="text-sm text-gray-200 font-mono">--</div>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Global variables
    let timerInterval = null;
    let startTime = null;
    let isPatientDetected = false;
    let irHistory = [];
    let redHistory = [];
    let timer = 0; // seconds
    
    // Session tracking
    let currentSession = {
      bpmValues: [],
      spo2Values: [],
      startTime: null,
      isActive: false
    };
    
    let lastSession = {
      endTime: null,
      finalBpm: null,
      finalSpo2: null,
      avgBpm: null,
      avgSpo2: null,
      duration: null
    };

    // DOM elements
    const elements = {
      statusCard: document.getElementById('statusCard'),
      statusTitle: document.getElementById('statusTitle'),
      statusIcon: document.getElementById('statusIcon'),
      statusDot: document.getElementById('statusDot'),
      timerDisplay: document.getElementById('timerDisplay'),
      timerSub: document.getElementById('timerSub'),
      connDot: document.getElementById('connDot'),
      connText: document.getElementById('connText'),
      bpmValue: document.getElementById('bpmValue'),
      spo2Value: document.getElementById('spo2Value'),
      bpmStatus: document.getElementById('bpmStatus'),
      spo2Status: document.getElementById('spo2Status'),
      irVal: document.getElementById('irVal'),
      redVal: document.getElementById('redVal'),
      lastUpdate: document.getElementById('lastUpdate'),
      
      // Session elements
      sessionStatus: document.getElementById('sessionStatus'),
      currentSessionData: document.getElementById('currentSessionData'),
      lastSessionData: document.getElementById('lastSessionData'),
      currentBpm: document.getElementById('currentBpm'),
      currentSpo2: document.getElementById('currentSpo2'),
      avgBpm: document.getElementById('avgBpm'),
      avgSpo2: document.getElementById('avgSpo2'),
      lastSessionTime: document.getElementById('lastSessionTime'),
      lastBpm: document.getElementById('lastBpm'),
      lastSpo2: document.getElementById('lastSpo2'),
      lastAvgBpm: document.getElementById('lastAvgBpm'),
      lastAvgSpo2: document.getElementById('lastAvgSpo2'),
      lastSessionDuration: document.getElementById('lastSessionDuration')
    };

    // Detection thresholds - adjust based on your sensor
    const DETECTION_THRESHOLDS = {
      IR_MIN: 1000,
      RED_MIN: 1000
    };

    // Finger presence detection
    function detectFingerPresence(ir, red) {
      return ir > DETECTION_THRESHOLDS.IR_MIN && red > DETECTION_THRESHOLDS.RED_MIN;
    }

    // Update patient status
    function updatePatientStatus(detected) {
      if (detected && !isPatientDetected) {
        // Finger detected - start new session
        elements.statusCard.className = 'card status-accent status-green flex items-center justify-between';
        elements.statusTitle.textContent = 'Paciente identificado';
        elements.statusIcon.setAttribute('data-lucide', 'user-check');
        elements.statusDot.className = 'w-4 h-4 rounded-full bg-green-500 pulse';
        
        startTimer();
        startSession();
        isPatientDetected = true;
        
        // Update session display
        elements.sessionStatus.textContent = 'Monitorando';
        elements.currentSessionData.style.display = 'block';
        elements.lastSessionData.style.display = 'none';
        
        // Recreate icon
        lucide.createIcons();
        
      } else if (!detected && isPatientDetected) {
        // Finger removed - end session
        elements.statusCard.className = 'card status-accent status-red flex items-center justify-between';
        elements.statusTitle.textContent = 'Paciente n√£o identificado';
        elements.statusIcon.setAttribute('data-lucide', 'user-x');
        elements.statusDot.className = 'w-4 h-4 rounded-full bg-red-500 pulse';
        
        stopTimer();
        endSession();
        resetMetrics();
        isPatientDetected = false;
        
        // Update session display
        elements.sessionStatus.textContent = '√öltima sess√£o';
        elements.currentSessionData.style.display = 'none';
        elements.lastSessionData.style.display = 'block';
        
        // Recreate icon
        lucide.createIcons();
      }
    }

    // Timer functions
    function startTimer() {
      if (timerInterval) return;
      
      startTime = Date.now();
      elements.timerSub.textContent = 'Monitorando';
      timer = 0;
      
      timerInterval = setInterval(() => {
        timer++;
        const mm = String(Math.floor(timer / 60)).padStart(2, '0');
        const ss = String(timer % 60).padStart(2, '0');
        elements.timerDisplay.textContent = mm + ':' + ss;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      elements.timerSub.textContent = 'Aguardando';
    }

    function resetMetrics() {
      elements.bpmValue.textContent = '--';
      elements.spo2Value.textContent = '--';
      elements.bpmStatus.style.display = 'none';
      elements.spo2Status.style.display = 'none';
      irHistory = [];
      redHistory = [];
    }
    
    // Session management functions
    function startSession() {
      currentSession = {
        bpmValues: [],
        spo2Values: [],
        startTime: Date.now(),
        isActive: true
      };
      console.log('üéØ Nova sess√£o iniciada');
    }
    
    function endSession() {
      if (!currentSession.isActive) return;
      
      // Calculate final averages
      const avgBpm = currentSession.bpmValues.length > 0 
        ? Math.round(currentSession.bpmValues.reduce((a, b) => a + b, 0) / currentSession.bpmValues.length)
        : null;
        
      const avgSpo2 = currentSession.spo2Values.length > 0
        ? Math.round(currentSession.spo2Values.reduce((a, b) => a + b, 0) / currentSession.spo2Values.length)
        : null;
      
      // Get final values
      const finalBpm = currentSession.bpmValues.length > 0 
        ? currentSession.bpmValues[currentSession.bpmValues.length - 1] 
        : null;
        
      const finalSpo2 = currentSession.spo2Values.length > 0
        ? currentSession.spo2Values[currentSession.spo2Values.length - 1]
        : null;
      
      // Calculate duration
      const duration = timer; // timer is already in seconds
      
      // Save to last session
      lastSession = {
        endTime: new Date().toLocaleTimeString('pt-BR'),
        finalBpm: finalBpm,
        finalSpo2: finalSpo2,
        avgBpm: avgBpm,
        avgSpo2: avgSpo2,
        duration: formatDuration(duration)
      };
      
      // Update display
      updateLastSessionDisplay();
      
      // Mark session as inactive
      currentSession.isActive = false;
      
      console.log('üèÅ Sess√£o finalizada:', lastSession);
    }
    
    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}m ${secs}s`;
    }
    
    function updateCurrentSessionDisplay() {
      if (!currentSession.isActive) return;
      
      // Update current values
      const currentBpmText = elements.bpmValue.textContent;
      const currentSpo2Text = elements.spo2Value.textContent;
      
      elements.currentBpm.textContent = currentBpmText !== '--' ? `${currentBpmText} BPM` : '--';
      elements.currentSpo2.textContent = currentSpo2Text !== '--' ? `${currentSpo2Text}%` : '--';
      
      // Calculate and show averages
      if (currentSession.bpmValues.length > 0) {
        const avgBpm = Math.round(currentSession.bpmValues.reduce((a, b) => a + b, 0) / currentSession.bpmValues.length);
        elements.avgBpm.textContent = `${avgBpm} BPM`;
      } else {
        elements.avgBpm.textContent = '--';
      }
      
      if (currentSession.spo2Values.length > 0) {
        const avgSpo2 = Math.round(currentSession.spo2Values.reduce((a, b) => a + b, 0) / currentSession.spo2Values.length);
        elements.avgSpo2.textContent = `${avgSpo2}%`;
      } else {
        elements.avgSpo2.textContent = '--';
      }
    }
    
    function updateLastSessionDisplay() {
      elements.lastSessionTime.textContent = lastSession.endTime || '--';
      elements.lastBpm.textContent = lastSession.finalBpm ? `${lastSession.finalBpm} BPM` : '--';
      elements.lastSpo2.textContent = lastSession.finalSpo2 ? `${lastSession.finalSpo2}%` : '--';
      elements.lastAvgBpm.textContent = lastSession.avgBpm ? `${lastSession.avgBpm} BPM` : '--';
      elements.lastAvgSpo2.textContent = lastSession.avgSpo2 ? `${lastSession.avgSpo2}%` : '--';
      elements.lastSessionDuration.textContent = lastSession.duration || '--';
    }
    
    function addToSession(bpm, spo2) {
      if (!currentSession.isActive) return;
      
      if (bpm && bpm > 0) {
        currentSession.bpmValues.push(bpm);
      }
      
      if (spo2 && spo2 > 0) {
        currentSession.spo2Values.push(spo2);
      }
      
      updateCurrentSessionDisplay();
    }

    // BPM calculation (simplified algorithm)
    function calculateBPM() {
      if (irHistory.length < 30) return null;
      
      const recent = irHistory.slice(-30);
      const sampleRate = 1; // 1 sample per second
      
      // Simple peak detection
      let peaks = [];
      for (let i = 1; i < recent.length - 1; i++) {
        if (recent[i] > recent[i-1] && recent[i] > recent[i+1]) {
          const threshold = Math.max(...recent) * 0.6;
          if (recent[i] > threshold) {
            peaks.push(i);
          }
        }
      }
      
      if (peaks.length < 2) return null;
      
      // Calculate average interval between peaks
      let intervals = [];
      for (let i = 1; i < peaks.length; i++) {
        intervals.push(peaks[i] - peaks[i-1]);
      }
      
      if (intervals.length === 0) return null;
      
      const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
      const bpm = Math.round(60 / (avgInterval * sampleRate));
      
      return (bpm > 40 && bpm < 200) ? bpm : null;
    }

    // SpO2 calculation (simplified)
    function calculateSpO2() {
      if (irHistory.length < 20 || redHistory.length < 20) return null;
      
      const irRecent = irHistory.slice(-20);
      const redRecent = redHistory.slice(-20);
      
      const irAvg = irRecent.reduce((a, b) => a + b, 0) / irRecent.length;
      const redAvg = redRecent.reduce((a, b) => a + b, 0) / redRecent.length;
      
      if (irAvg === 0 || redAvg === 0) return null;
      
      // Simplified SpO2 calculation
      const ratio = redAvg / irAvg;
      let spo2 = 110 - 25 * ratio;
      
      // Clamp between realistic values
      spo2 = Math.max(85, Math.min(100, Math.round(spo2)));
      
      return spo2;
    }

    // Update metric status indicators
    function updateMetricStatus(value, type) {
      const statusElement = elements[type + 'Status'];
      statusElement.style.display = 'block';
      
      if (type === 'bpm') {
        if (value >= 60 && value <= 100) {
          statusElement.className = 'mt-3 px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
          statusElement.textContent = 'Normal';
        } else if (value < 60) {
          statusElement.className = 'mt-3 px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
          statusElement.textContent = 'Bradicardia';
        } else {
          statusElement.className = 'mt-3 px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
          statusElement.textContent = 'Taquicardia';
        }
      } else if (type === 'spo2') {
        if (value >= 95) {
          statusElement.className = 'mt-3 px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
          statusElement.textContent = 'Normal';
        } else if (value >= 90) {
          statusElement.className = 'mt-3 px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
          statusElement.textContent = 'Baixo';
        } else {
          statusElement.className = 'mt-3 px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
          statusElement.textContent = 'Cr√≠tico';
        }
      }
    }

    // Main data fetching function
    async function fetchData() {
      try {
        const response = await fetch('http://localhost:3000/api/data');
        const data = await response.json();
        
        if (data && data.ir && data.red) {
          // Update connection status
          elements.connDot.className = 'w-3 h-3 rounded-full bg-green-400 inline-block';
          elements.connText.textContent = 'Conectado';
          
          // Update raw data display
          elements.irVal.textContent = data.ir.toLocaleString();
          elements.redVal.textContent = data.red.toLocaleString();
          elements.lastUpdate.textContent = new Date().toLocaleTimeString('pt-BR');
          
          // Add to history
          irHistory.push(data.ir);
          redHistory.push(data.red);
          
          // Keep only last 100 values
          if (irHistory.length > 100) {
            irHistory.shift();
            redHistory.shift();
          }
          
          // Detect finger presence
          const fingerDetected = detectFingerPresence(data.ir, data.red);
          updatePatientStatus(fingerDetected);
          
          // Calculate metrics only if finger is present
          if (isPatientDetected) {
            const bpm = calculateBPM();
            const spo2 = calculateSpO2();
            
            if (bpm) {
              elements.bpmValue.textContent = bpm;
              updateMetricStatus(bpm, 'bpm');
            }
            
            if (spo2) {
              elements.spo2Value.textContent = spo2;
              updateMetricStatus(spo2, 'spo2');
            }
            
            // Add to current session for averages
            addToSession(bpm, spo2);
          }
        } else {
          // No data received
          elements.connDot.className = 'w-3 h-3 rounded-full bg-yellow-400 inline-block';
          elements.connText.textContent = 'Sem dados';
        }
      } catch (error) {
        console.error('Erro ao buscar dados:', error);
        elements.connDot.className = 'w-3 h-3 rounded-full bg-red-400 inline-block';
        elements.connText.textContent = 'Erro de conex√£o';
      }
    }

    // Initialize application
    function init() {
      console.log('üöÄ LoRaCare iniciado');
      
      // Initial icon setup
      lucide.createIcons();
      
      // Initialize session display
      elements.currentSessionData.style.display = 'none';
      elements.lastSessionData.style.display = 'block';
      elements.sessionStatus.textContent = 'Aguardando';
      
      // Initialize theme toggle
      initThemeToggle();
      
      // Start data fetching
      fetchData();
      setInterval(fetchData, 1000); // Update every second
    }
    
    // Theme toggle functionality
    function initThemeToggle() {
      const themeToggle = document.getElementById('themeToggle');
      const themeIndicator = document.getElementById('themeIndicator');
      const themeText = document.getElementById('themeText');
      let currentTheme = 'original';
      
      themeToggle.addEventListener('click', () => {
        if (currentTheme === 'original') {
          // Switch to bridge theme
          document.body.className = 'text-gray-800 theme-bridge';
          themeIndicator.className = 'theme-indicator bridge';
          themeText.textContent = 'Tema Slides';
          currentTheme = 'bridge';
          console.log('üåø Tema alterado para: Ponte com Slides');
        } else {
          // Switch to original theme
          document.body.className = 'text-gray-800 theme-original';
          themeIndicator.className = 'theme-indicator original';
          themeText.textContent = 'Tema Autoral';
          currentTheme = 'original';
          console.log('üöÄ Tema alterado para: Autoral Tecnol√≥gico');
        }
      });
      
      // Add hover effects
      themeToggle.addEventListener('mouseenter', () => {
        themeToggle.style.transform = 'scale(1.05)';
      });
      
      themeToggle.addEventListener('mouseleave', () => {
        themeToggle.style.transform = 'scale(1)';
      });
    }

    // Start when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>