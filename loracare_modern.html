<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRaCare - Monitoramento de Sa√∫de</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .main-section {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }

        .sidebar {
            display: grid;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.18);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        /* Status do Paciente */
        .patient-status {
            text-align: center;
            padding: 30px 24px;
            border-left: 6px solid #e74c3c;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            transition: all 0.5s ease;
        }

        .patient-status.identified {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .patient-status h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .patient-status.identified h2 {
            color: #155724;
        }

        .patient-status:not(.identified) h2 {
            color: #721c24;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .patient-status.identified .status-indicator {
            background: #27ae60;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Timer */
        .timer-card {
            text-align: center;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
        }

        .timer-card h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 400;
            opacity: 0.9;
        }

        .timer-display {
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .timer-status {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* M√©tricas de Sa√∫de */
        .health-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .metric-card {
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #e74c3c, #f39c12);
        }

        .metric-card.bpm::before {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .metric-card.spo2::before {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .metric-card h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .metric-unit {
            font-size: 1rem;
            color: #7f8c8d;
            font-weight: 400;
        }

        .metric-status {
            margin-top: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .normal {
            background: #d4edda;
            color: #155724;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
        }

        .danger {
            background: #f8d7da;
            color: #721c24;
        }

        /* Dados Brutos */
        .raw-data {
            background: #2c3e50;
            color: white;
            border: none;
        }

        .raw-data h3 {
            color: #ecf0f1;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .data-label {
            font-weight: 500;
            opacity: 0.8;
        }

        .data-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .health-metrics {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .timer-display {
                font-size: 2.5rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 16px;
            }
            
            .patient-status {
                padding: 20px 16px;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <!-- Status de Conex√£o -->
    <div id="connectionStatus" class="connection-status disconnected">
        üî¥ Desconectado
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>LoRaCare</h1>
            <p>Monitoramento de Sa√∫de em Tempo Real</p>
        </header>

        <!-- Dashboard Principal -->
        <div class="dashboard">
            <!-- Se√ß√£o Principal -->
            <div class="main-section">
                <!-- Status do Paciente -->
                <div id="patientStatus" class="card patient-status">
                    <h2>Paciente n√£o identificado</h2>
                    <span class="status-indicator"></span>
                </div>

                <!-- M√©tricas de Sa√∫de -->
                <div class="health-metrics">
                    <!-- Batimentos Card√≠acos -->
                    <div class="card metric-card bpm">
                        <h3>Batimentos Card√≠acos</h3>
                        <div class="metric-value" id="bpmValue">--</div>
                        <div class="metric-unit">BPM</div>
                        <div id="bpmStatus" class="metric-status normal" style="display: none;">Normal</div>
                    </div>

                    <!-- Oxigena√ß√£o -->
                    <div class="card metric-card spo2">
                        <h3>Oxigena√ß√£o</h3>
                        <div class="metric-value" id="spo2Value">--</div>
                        <div class="metric-unit">%</div>
                        <div id="spo2Status" class="metric-status normal" style="display: none;">Normal</div>
                    </div>
                </div>
            </div>

            <!-- Barra Lateral -->
            <div class="sidebar">
                <!-- Timer -->
                <div class="card timer-card">
                    <h3>‚è±Ô∏è Tempo de Monitoramento</h3>
                    <div class="timer-display" id="timerDisplay">00:00</div>
                    <div class="timer-status" id="timerStatus">Aguardando</div>
                </div>

                <!-- Dados Brutos -->
                <div class="card raw-data">
                    <h3>üìä Dados do Sensor</h3>
                    <div class="data-row">
                        <span class="data-label">IR:</span>
                        <span class="data-value" id="irValue">--</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">RED:</span>
                        <span class="data-value" id="redValue">--</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">√öltima atualiza√ß√£o:</span>
                        <span class="data-value" id="lastUpdate">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let timerInterval = null;
        let startTime = null;
        let isPatientDetected = false;
        let irHistory = [];
        let redHistory = [];
        let lastHeartbeatTime = 0;

        // Elementos DOM
        const elements = {
            patientStatus: document.getElementById('patientStatus'),
            timerDisplay: document.getElementById('timerDisplay'),
            timerStatus: document.getElementById('timerStatus'),
            bpmValue: document.getElementById('bpmValue'),
            spo2Value: document.getElementById('spo2Value'),
            bpmStatus: document.getElementById('bpmStatus'),
            spo2Status: document.getElementById('spo2Status'),
            irValue: document.getElementById('irValue'),
            redValue: document.getElementById('redValue'),
            lastUpdate: document.getElementById('lastUpdate'),
            connectionStatus: document.getElementById('connectionStatus')
        };

        // Fun√ß√£o para detectar se o dedo est√° presente
        function detectFingerPresence(ir, red) {
            // Thresholds para detec√ß√£o - ajuste conforme necess√°rio
            const IR_THRESHOLD = 1000;
            const RED_THRESHOLD = 1000;
            
            return ir > IR_THRESHOLD && red > RED_THRESHOLD;
        }

        // Fun√ß√£o para atualizar o status do paciente
        function updatePatientStatus(detected) {
            const statusElement = elements.patientStatus;
            const statusText = statusElement.querySelector('h2');
            
            if (detected && !isPatientDetected) {
                // Dedo detectado
                statusElement.classList.add('identified');
                statusText.textContent = 'Paciente identificado';
                startTimer();
                isPatientDetected = true;
            } else if (!detected && isPatientDetected) {
                // Dedo removido
                statusElement.classList.remove('identified');
                statusText.textContent = 'Paciente n√£o identificado';
                stopTimer();
                resetMetrics();
                isPatientDetected = false;
            }
        }

        // Fun√ß√µes do Timer
        function startTimer() {
            if (timerInterval) return;
            
            startTime = Date.now();
            elements.timerStatus.textContent = 'Monitorando';
            
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                elements.timerDisplay.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            elements.timerStatus.textContent = 'Parado';
        }

        function resetMetrics() {
            elements.bpmValue.textContent = '--';
            elements.spo2Value.textContent = '--';
            elements.bpmStatus.style.display = 'none';
            elements.spo2Status.style.display = 'none';
            irHistory = [];
            redHistory = [];
        }

        // Fun√ß√£o para calcular BPM (simplificado - precisa de algoritmo mais sofisticado)
        function calculateBPM() {
            if (irHistory.length < 20) return null;
            
            // Algoritmo simplificado - em produ√ß√£o usar FFT ou detec√ß√£o de picos
            const recent = irHistory.slice(-20);
            const avg = recent.reduce((a, b) => a + b, 0) / recent.length;
            const variance = recent.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / recent.length;
            
            // Estimativa baseada na vari√¢ncia (placeholder)
            if (variance > 1000) {
                return Math.floor(60 + (variance / 1000) * 20); // Entre 60-80 BPM
            }
            return null;
        }

        // Fun√ß√£o para calcular SpO2 (simplificado)
        function calculateSpO2() {
            if (irHistory.length < 10 || redHistory.length < 10) return null;
            
            const irAvg = irHistory.slice(-10).reduce((a, b) => a + b, 0) / 10;
            const redAvg = redHistory.slice(-10).reduce((a, b) => a + b, 0) / 10;
            
            if (irAvg === 0 || redAvg === 0) return null;
            
            // Algoritmo simplificado - em produ√ß√£o usar calibra√ß√£o real
            const ratio = redAvg / irAvg;
            const spo2 = Math.floor(110 - 25 * ratio);
            
            return Math.max(85, Math.min(100, spo2)); // Limitar entre 85-100%
        }

        // Fun√ß√£o para atualizar status das m√©tricas
        function updateMetricStatus(value, type) {
            const statusElement = elements[type + 'Status'];
            statusElement.style.display = 'block';
            
            if (type === 'bpm') {
                if (value >= 60 && value <= 100) {
                    statusElement.className = 'metric-status normal';
                    statusElement.textContent = 'Normal';
                } else if (value < 60 || value > 100) {
                    statusElement.className = 'metric-status warning';
                    statusElement.textContent = value < 60 ? 'Bradicardia' : 'Taquicardia';
                }
            } else if (type === 'spo2') {
                if (value >= 95) {
                    statusElement.className = 'metric-status normal';
                    statusElement.textContent = 'Normal';
                } else if (value >= 90) {
                    statusElement.className = 'metric-status warning';
                    statusElement.textContent = 'Baixo';
                } else {
                    statusElement.className = 'metric-status danger';
                    statusElement.textContent = 'Cr√≠tico';
                }
            }
        }

        // Fun√ß√£o principal para buscar dados
        async function fetchData() {
            try {
                const response = await fetch('http://localhost:3000/api/data');
                const data = await response.json();
                
                if (data && data.ir && data.red) {
                    // Atualizar conex√£o
                    elements.connectionStatus.className = 'connection-status connected';
                    elements.connectionStatus.innerHTML = 'üü¢ Conectado';
                    
                    // Atualizar dados brutos
                    elements.irValue.textContent = data.ir.toLocaleString();
                    elements.redValue.textContent = data.red.toLocaleString();
                    elements.lastUpdate.textContent = new Date().toLocaleTimeString();
                    
                    // Adicionar ao hist√≥rico
                    irHistory.push(data.ir);
                    redHistory.push(data.red);
                    
                    // Manter apenas os √∫ltimos 100 valores
                    if (irHistory.length > 100) {
                        irHistory.shift();
                        redHistory.shift();
                    }
                    
                    // Detectar presen√ßa do dedo
                    const fingerDetected = detectFingerPresence(data.ir, data.red);
                    updatePatientStatus(fingerDetected);
                    
                    // Calcular m√©tricas apenas se o dedo estiver presente
                    if (isPatientDetected) {
                        const bpm = calculateBPM();
                        const spo2 = calculateSpO2();
                        
                        if (bpm) {
                            elements.bpmValue.textContent = bpm;
                            updateMetricStatus(bpm, 'bpm');
                        }
                        
                        if (spo2) {
                            elements.spo2Value.textContent = spo2;
                            updateMetricStatus(spo2, 'spo2');
                        }
                    }
                } else {
                    elements.connectionStatus.className = 'connection-status disconnected';
                    elements.connectionStatus.innerHTML = 'üî¥ Sem dados';
                }
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                elements.connectionStatus.className = 'connection-status disconnected';
                elements.connectionStatus.innerHTML = 'üî¥ Erro de conex√£o';
            }
        }

        // Inicializar aplica√ß√£o
        function init() {
            console.log('üöÄ LoRaCare iniciado');
            fetchData();
            setInterval(fetchData, 1000); // Atualizar a cada segundo
        }

        // Iniciar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>